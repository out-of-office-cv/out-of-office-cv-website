name: Close stale PRs with empty diffs

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  close-stale-prs:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Close PRs with no file changes
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;

            const { data: prs } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              per_page: 100,
            });

            const gigPrs = prs.filter(pr =>
              pr.head.ref.startsWith('gig-contribution-') ||
              pr.head.ref.startsWith('gig-verification-')
            );

            for (const pr of gigPrs) {
              const { data: files } = await github.rest.pulls.listFiles({
                owner,
                repo,
                pull_number: pr.number,
              });

              if (files.length === 0) {
                console.log(`Closing PR #${pr.number} (${pr.title}) - no file changes`);

                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: pr.number,
                  body: 'Closing this PR automatically: it has no file changes compared to main. This usually happens when another PR with the same changes was merged first.',
                });

                await github.rest.pulls.update({
                  owner,
                  repo,
                  pull_number: pr.number,
                  state: 'closed',
                });
              }
            }
